<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Grist Weather Fetcher - onRecords Test</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        body { font-family: sans-serif; padding: 10px; }
        #status { margin-top: 10px; padding: 8px; background-color: #eee; border-radius: 4px; }
    </style>
</head>
<body>
    <h3>Тест подписки на Table2</h3>
    <div id="status">Ожидание изменений в Table2...</div>

    <script>
        // === НАЧАЛО СКРИПТА - ЛОГ ВЕРСИИ ===
        const WIDGET_VERSION = "v1.13.7"; 
        console.log(`DEBUG: Grist Weather Widget (onRecords Test) Загружен - Версия ${WIDGET_VERSION}`);

        const TABLE2_ID_TO_WATCH = "Table2"; // <<< УБЕДИТЕСЬ, ЧТО ЭТО ПРАВИЛЬНЫЙ ID ВАШЕЙ ТАБЛИЦЫ
        const statusDiv = document.getElementById('status');

        function diagnosticTable2ChangesCallback(records, changes) {
            console.log("!!!! DIAGNOSTIC: diagnosticTable2ChangesCallback ВЫЗВАНА !!!!");
            console.log("DIAGNOSTIC: Аргумент 'records' (тип):", typeof records, "Содержимое (начало):", JSON.stringify(records).substring(0, 300) + "...");
            console.log("DIAGNOSTIC: Array.isArray(records):", Array.isArray(records));
            if (Array.isArray(records) && records.length > 0 && typeof records[0] === 'object') {
                console.log("DIAGNOSTIC: Первый элемент 'records':", records[0]);
            }
            console.log("DIAGNOSTIC: Аргумент 'changes' (тип):", typeof changes, "Содержимое:", JSON.stringify(changes, null, 2));
            
            let changesSummary = "Детали изменений отсутствуют или в неожиданном формате.";
            if (changes && changes.updated && changes.updated instanceof Map && changes.updated.size > 0) {
                changesSummary = `Обновлено ${changes.updated.size} строк. ID первой измененной строки: ${changes.updated.keys().next().value}`;
            } else if (changes === null) {
                changesSummary = "Grist не смог предоставить детали изменений (changes is null).";
            } else if (changes) {
                changesSummary = "Объект changes получен, но не в ожидаемом формате Map.";
            }

            statusDiv.innerHTML = `Событие для ${TABLE2_ID_TO_WATCH} получено!<br>
                                   Получено записей: ${records ? records.length : 'N/A'}.<br>
                                   Изменения: ${changesSummary}<br>
                                   Полный объект changes: ${JSON.stringify(changes, null, 2)}`;
        }

        function initGrist() {
            console.log("DEBUG: initGrist() called");
            if (typeof grist === 'undefined' || !grist.ready) {
                console.error("Grist API не найден.");
                statusDiv.textContent = "Ошибка: Grist API не найден.";
                return;
            }

            grist.ready(); 

            grist.onOptions((options, interaction) => {
                console.log("DEBUG: grist.onOptions вызвана (это нормально, для активации).");
            });
            
            console.log(`DEBUG: Попытка подписаться на изменения в таблице с ID: "${TABLE2_ID_TO_WATCH}" (grist.onRecords)`); 
            try {
                grist.onRecords(diagnosticTable2ChangesCallback, TABLE2_ID_TO_WATCH); 
                console.log(`DEBUG: Успешно подписан на изменения в таблице с ID: "${TABLE2_ID_TO_WATCH}" (grist.onRecords)`); 
                statusDiv.textContent = `Виджет готов и слушает изменения в таблице "${TABLE2_ID_TO_WATCH}". Пожалуйста, измените данные в этой таблице.`;
            } catch (e) {
                console.error(`ОШИБКА при подписке на изменения в ${TABLE2_ID_TO_WATCH} (grist.onRecords):`, e);
                statusDiv.innerHTML = `ОШИБКА: не удалось подписаться на изменения в ${TABLE2_ID_TO_WATCH}.\n${e.message}`;
            }
            console.log(`DEBUG: Grist API настроен и готов. Версия виджета: ${WIDGET_VERSION}`);
        }
        initGrist();
    </script>
</body>
</html>
