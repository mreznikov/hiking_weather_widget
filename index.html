<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Grist Weather Fetcher</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        body { font-family: sans-serif; padding: 10px; background-color: #f0f0f0; }
        #status { margin-top: 10px; padding: 8px; background-color: #fff; border-radius: 4px; min-height: 40px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h3>Тест подписки на Table2</h3>
    <div id="status">Ожидание изменений в Table2...</div>

    <script>
        // === НАЧАЛО СКРИПТА - ЛОГ ВЕРСИИ ===
        const WIDGET_VERSION = "v1.13.4"; 
        console.log(`DEBUG: Grist Weather Widget Загружен - Версия ${WIDGET_VERSION}`);

        const TABLE2_ID = "Table2"; // Убедитесь, что это ТОЧНЫЙ ID вашей таблицы в Grist
        const statusDiv = document.getElementById('status');

        function diagnosticTable2ChangesCallback(records, changes) {
            console.log("!!!! DIAGNOSTIC: handleTable2Changes (КОЛБЭК) ВЫЗВАНА !!!!");
            console.log("DIAGNOSTIC: Аргумент 'records':", records);
            console.log("DIAGNOSTIC: Аргумент 'changes':", changes);
            statusDiv.innerHTML = `Событие для Table2! Записей: ${records ? records.length : 'N/A'}.<br>Изменения: ${JSON.stringify(changes, null, 2)}`;
        }

        function initGrist() {
            console.log("DEBUG: initGrist() called");
            if (typeof grist === 'undefined' || !grist.ready) {
                console.error("Grist API не найден.");
                statusDiv.textContent = "Ошибка: Grist API не найден.";
                return;
            }

            grist.ready(); // Минимальный вызов ready, так как мы не привязываемся к колонкам Table1 в этом тесте

            grist.onOptions((options, interaction) => {
                // Эта часть нужна, чтобы виджет считался "активным"
                console.log("DEBUG: grist.onOptions - options:", options, "interaction:", interaction);
            });
            
            console.log(`DEBUG: Попытка подписаться на изменения в ${TABLE2_ID} (onRecords)`); 
            try {
                grist.onRecords(diagnosticTable2ChangesCallback, TABLE2_ID); 
                console.log(`DEBUG: Успешно подписан на изменения в ${TABLE2_ID} (onRecords)`); 
                statusDiv.textContent = `Виджет готов и слушает изменения в ${TABLE2_ID}. Измените данные в этой таблице.`;
            } catch (e) {
                console.error(`ОШИБКА при подписке на изменения в ${TABLE2_ID} (onRecords):`, e);
                statusDiv.innerHTML = `ОШИБКА: не удалось подписаться на изменения в ${TABLE2_ID}.\n${e.message}`;
            }
            console.log(`DEBUG: Grist API настроен и готов. Версия виджета: ${WIDGET_VERSION}`);
        }
        initGrist();
    </script>
</body>
</html>

