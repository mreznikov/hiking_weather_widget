<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Grist Weather Fetcher - onRecords Test</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        body { font-family: sans-serif; padding: 10px; }
        #status { margin-top: 10px; padding: 8px; background-color: #eee; border-radius: 4px; }
    </style>
</head>
<body>
    <h3>Тест подписки на изменения в Table2</h3>
    <div id="status">Ожидание изменений в Table2...</div>

    <script>
        const WIDGET_VERSION = "v1.13.5";
        console.log(`DEBUG: Grist Weather Widget (onRecords Test) Загружен - Версия ${WIDGET_VERSION}`);

        const TABLE2_ID_TO_WATCH = "Table2"; // <<< УБЕДИТЕСЬ, ЧТО ЭТО ПРАВИЛЬНЫЙ ID ВАШЕЙ ТАБЛИЦЫ
        const statusDiv = document.getElementById('status');

        function diagnosticTable2ChangesCallback(records, changes) {
            console.log("!!!! DIAGNOSTIC: diagnosticTable2ChangesCallback ВЫЗВАНА !!!!");
            console.log("DIAGNOSTIC: Аргумент 'records':", records);
            console.log("DIAGNOSTIC: Аргумент 'changes':", changes);
            statusDiv.innerHTML = `Событие для ${TABLE2_ID_TO_WATCH} получено!<br>Записей: ${records ? records.length : 'N/A'}.<br>Изменения: ${JSON.stringify(changes, null, 2)}`;
        }

        function initGrist() {
            console.log("DEBUG: initGrist() called");
            if (typeof grist === 'undefined' || !grist.ready) {
                console.error("Grist API не найден.");
                statusDiv.textContent = "Ошибка: Grist API не найден.";
                return;
            }

            grist.ready(); // Минимальный вызов, так как мы не привязываемся к колонкам

            grist.onOptions((options, interaction) => {
                console.log("DEBUG: grist.onOptions вызвана (это нормально, для активации).");
            });
            
            console.log(`DEBUG: Попытка подписаться на изменения в таблице с ID: "${TABLE2_ID_TO_WATCH}" (grist.onRecords)`); 
            try {
                grist.onRecords(diagnosticTable2ChangesCallback, TABLE2_ID_TO_WATCH); 
                console.log(`DEBUG: Успешно подписан на изменения в таблице с ID: "${TABLE2_ID_TO_WATCH}" (grist.onRecords)`); 
                statusDiv.textContent = `Виджет готов и слушает изменения в таблице "${TABLE2_ID_TO_WATCH}". Пожалуйста, измените данные в этой таблице.`;
            } catch (e) {
                console.error(`ОШИБКА при подписке на изменения в ${TABLE2_ID_TO_WATCH} (grist.onRecords):`, e);
                statusDiv.innerHTML = `ОШИБКА: не удалось подписаться на изменения в ${TABLE2_ID_TO_WATCH}.\n${e.message}`;
            }
            console.log(`DEBUG: Grist API настроен и готов. Версия виджета: ${WIDGET_VERSION}`);
        }
        initGrist();
    </script>
</body>
</html>
